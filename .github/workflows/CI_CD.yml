name: Push  a Docker Image 
on:
 push:
  branches:
  - main
 workflow_dispatch:
jobs:
  train:
    runs-on: self-hosted
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python 3.10
      uses: actions/setup-python@v3
      with:
       python-version: '3.10'
    - name: Install dependencies
      run: pip install -r requirements.txt
    - name: Train and save pipeline
      run: python Model.py
    - uses: actions/upload-artifact@v2
      with:
       name: my-trained-pipeline
       path: wheat_model_api/*.pkl
       retention-days: 1
  test:
   needs: train
   runs-on: self-hosted
   steps:
    - uses: actions/checkout@v3
    - name: Set up Python 3.10
      uses: actions/setup-python@v3
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: pip install -r requirements.txt
    - name: Test with pytest
      run: pytest
  lint:
   needs: [train, test]
   runs-on: self-hosted
   steps:
   - uses: actions/checkout@v3
   - name: Install dependencies
     run: pip install pylint
   - name: pylint the setup file
     run: pylint setup.py
  black:
   needs: [train, test, lint]
   runs-on: self-hosted
   steps:
   - uses: actions/checkout@v3
   - name: Install dependencies
     run: pip install black
   - name: black the setup file
     run: black .
  build:
    needs: [train, test, lint, black]
    runs-on: self-hosted
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python 3.10
      uses: actions/setup-python@v3
      with:
       python-version: '3.10'
    - uses: actions/download-artifact@v2
      with:
       name: my-trained-pipeline
       path: wheat_model_api/trained_models
    - name: Install dependencies
      run: pip install --upgrade build
    - name: Build package
      run: python -m build
    - uses: actions/upload-artifact@v2
      with:
        name: my-build-package
        path: dist/*.whl
        retention-days: 1
 
  push-image:
   needs: [train, test, build]
   runs-on: self-hosted
   steps:
   - name: Repo Checkout
     uses: actions/checkout@v2
   - uses: actions/download-artifact@v2
     with:
      name: my-build-package
      path: wheat_model_api
   - name: Login to Docker hub
     env:
      DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
     run : docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
   - name: Build the Docker image for Fastapi app
     env:
      DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
     run: docker build . -f Dockerfile -t $DOCKER_USER/wheat_model_api:v11
   - name: Push the Docker Image
     env:
      DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
     run: docker push $DOCKER_USER/wheat_model_api
   - name: Logout to Docker hub
     run: docker logout
  deploy:
    needs: [push-image]
    runs-on: self-hosted
    steps:
    - name: Pull Docker Image
      env: 
       DOCKER_USER: ${{ secrets.DOCKER_USER_NAME }}
      run: sudo docker pull $DOCKER_USER/wheat_model_api:latest
 
    - name: Delete Old Docker Container
      run: sudo docker rm -f wheat_model_api-container || true
 
    - name: Run Docker Container
      env: 
       DOCKER_USER: ${{ secrets.DOCKER_USER_NAME }}
      run: sudo docker run -it -d -p 8005:8005 --name wheat_model_api-container $DOCKER_USER/wheat_model_api:v11
    
  
